---
layout: post
published: true
title: Fun with URL Rewriting, WordPress, and IIS7
tags: Community Server, PHP, Tools, Software Development, .NET, IIS7, blogging, WordPress    
permalink: /2008-08-11-fun-with-url-rewriting-wordpress-and-iis7.html
description: Aside from wrapping my export routine in a WordPress friendly plugin, accurately transforming the URLs from my Community Server website has been the most time-
summary: Aside from wrapping my export routine in a WordPress friendly plugin, accurately transforming the URLs from my Community Server website has been the most time-consuming part of the Community Server to WordPress migration. A domain name change further complicated things, quickly devolving URL rewriting into a non-trivial endeavor.<br /><br />Keep in mind, however, that how you ultimately handle URL rewriting depends largely on where you are relocating to, and how you plan to get there. For example, if you've decided to make the switch to an Apache-based hosting solution, your options will be much different that moving to an IIS-based one.<br />
---
<div>Aside from wrapping my export routine in a WordPress friendly plugin, accurately transforming the URLs from my Community Server website has been the most time-consuming part of the Community Server to WordPress migration. A domain name change further complicated things, quickly devolving URL rewriting into a non-trivial endeavor.<br /><br />Keep in mind, however, that how you ultimately handle URL rewriting depends largely on where you are relocating to, and how you plan to get there. For example, if you've decided to make the switch to an Apache-based hosting solution, your options will be much different that moving to an IIS-based one.<br /><a name='more'></a><br />Because of some factors not directly related to the blog, I went down the shared-hosting-IIS road, which presented a set of unique challenges. In my case, I had some pretty particular requirements:<br /><ul><li>Rewrite old URLs in the most search engine friendly way possible.</li>
 <li>Not break any existing external links.</li>
 <li>Eliminate any lasting dependency on the Community Server database.</li>
 <li>Implement truly "pretty" URLs, so that I don't ever have to go through this process again.</li>
 <li>Continue to use shared hosting.</li>
 <li>Avoid having to inspect every incoming request regardless of whether it needed to be rewritten or not.</li>
 <li>Retain a single point of management for application hosting, regardless of the underlying technologies.</li>
 </ul>All pretty standard fare, really. But the last point above created an aversion to using a LAMP-based hosting package. I needed the ability to run PHP and MS.NET on the same server, preferably side-by-side. IIS7, here we come.<br /><br />The next problem I ran into was the availability of a ready-made, pattern based URL rewriting tool. Apache's mod_rewrite module wasn't an option. IIS7, when finally released in RTM form, will include a native URL rewriter much like it, but because this is presently a CTP add-on most hosting providers haven't installed it yet. ISAPI-based solutions like ISAPI Rewrite or the <a href="http://www.codeplex.com/IIRF">freeware IIRF component</a> are also options, but it's rare to find these in a shared hosting environment, and IIRF isn't II7 ready anyhow.<br /><br />I finally realized that I was going to have write some code to get what I wanted. Taking some cues from Dave Bost's <a href="http://davebost.com/blog/2008/01/28/attempting-some-permalink-magic/">post on the subject</a>, here's the high-level approach I followed:<br /><br />First, I installed the <em><a href="http://www.nathanm.com/myprojects/2008-08-11-fun-with-url-rewriting-wordpress-and-iis7.html#plugin">Remove index.php from Permalinks in IIS</a></em> plug-in to get rid of the "index.php" in my WordPress URLs. You may need to regenerate your permalinks in WordPress using the admin console before you get much further, since you'll need them to be production ready for the mapping process to work.<br /><br />Next I saved the output of the Google sitemap that is dynamically generated by Community Server as an XML document. In my case, this represented almost all of the URLs I had to worry about. If you're skilled in regex and/or SQL-XML, this file will come in <strong>very</strong> handy.<br /><br />At this point, I started poking around in the Community Server database, and realized something I hadn't paid much attention to before. Because I had upgraded through the years from DotText, the format of my links was inconsistent. Some used the pseudo-pretty Community Server format, while some were still in the ugly DotText format.<br /><br />After a bit of quick testing, I also discovered the method used to escape special characters in a URL is different in Community Server than it is in WordPress, and that Community Server allows multiple URL formats for the same content. Even though the latter probably wouldn't have a huge impact on SEO (since the alternate formats didn't appear in the sitemap output), I didn't want to risk breaking an external link somewhere. In the end, I decided to handle the following Community Server link formats, which meant three possible inbound matches for each WordPress post:<br /><pre class="kccodeblock"><code>&lt;!-- CS 2007 format --&gt;
<br />http://oldsite/archive/YYYY/mm/dd/some-intersting-post-title.aspx
<br />&lt;!-- some old CS format I think --&gt;
<br />http://oldsite/archive/YYYY/mm/dd/1446.aspx
<br />&lt;!-- legacy DotText format --&gt;
<br />http://oldsite/1234.aspx
<br /></code></pre>Once I had determined the link formats I was going to support, I grabbed the output from my <a href="http://wordpress.org/extend/plugins/google-sitemap-generator/">WordPress Google sitemap</a>. Again, you may need to regenerate this manually, since you're WordPress permalinks probably changed after installing the permalink plugin.<br /><br />After a few hours of some creative SQL-XML and regex work on the Community Server database, the Community Server sitemap, and the WordPress sitemap, I had an XML document that I could use to build an in-memory dictionary to map the old URLs. The schema looks something like this:<pre class="kccodeblock"><code>&lt;urls oldUrlRoot="http://kriscargile.com/" newUrlRoot="http://www.kristophercargile.com/"&gt;
<br />&lt;url sourceType="post"&gt;
<br />&lt;new&gt;2008/06/29/atlanta-scrum-users-group-formed/&lt;/new&gt;
<br />&lt;old&gt;archive/2008/06/29/atlanta-scrum-user-group-formed.aspx&lt;/old&gt;
<br />&lt;/url&gt;
<br />&lt;/urls&gt;
<br /></code></pre>I decided to represent the old and new root paths as attributes, since this greatly simplified local testing, and allowed me to use the newUrlRoot value as a fallback for an invalid or deleted URL.<br /><br />Using the Application_Start event handler in Global.asax, the XML file is parsed into a cached Hashtable. A cache dependency on the XML file allows for easy tweaks without the need to bounce IIS. Each inbound request is then handled by Application_BeginRequest&mdash;which handles <em>every</em> client request and fires at the start of the ASP.NET pipeline&mdash;to see if the old URL exists in the hashtable, and where the subsequent 301 should point to.<br /><br />Finally, I replaced the old Community Server website with the new Global.asax file. Once everything was tested and verified, I backed up my old Community Server database and dropped it.<br /><br />The source code for the rewriter is below. You'll need to generate your own content for the XML mapping file, though a stub is included.<br /><br />If you decide to use or extend it, I'd appreciate your feedback.<br /><br />klc;<br /><br /><a href='http://cdn.kriscargile.com/samples/cs2wp-url-reqwriter.zip'>cs2wp-url-rewriter.zip</a></div>